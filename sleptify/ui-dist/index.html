<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sleptify</title>
  <style>
    :root { --ink:#2f6e8a; }
    body { margin:0; background:transparent; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto; }
    .card { width:320px; margin:18px auto; background:rgba(255,255,255,.74); border:1px solid rgba(85,140,170,.25); border-radius:18px; padding:14px; box-shadow:0 10px 24px rgba(0,0,0,.08); backdrop-filter: blur(10px); }
    .cover { width:280px; height:280px; border-radius:16px; background:#eef5fb; object-fit:cover; display:block; margin:6px auto; }
    .title { color:#235b75; font-weight:700; margin:6px 12px 2px; font-size:16px; }
    .artist { color:#5a8ea8; margin:0 12px 10px; font-size:12px; }
    .row { display:flex; justify-content:center; gap:10px; margin-top:8px; }
    .btn { width:44px;height:44px;border-radius:50%;background:white;border:1px solid rgba(100,150,170,.35); color:var(--ink); font-size:18px; }
    .btn:active{ transform:scale(.97); }
    .seek { width:90%; height:8px; border-radius:999px; background:linear-gradient(90deg,#b7e3ff,#89c9f5); margin:6px auto; position:relative; }
    .heart { width:16px; height:16px; position:absolute; top:-4px; left:0; filter:drop-shadow(0 1px 1px rgba(0,0,0,.1)); }
    #connect { display:flex; justify-content:center; margin:8px 0 4px;}
    #connect button{ background:#eaf6ff; color:var(--ink);border:1px solid #9ccae0;padding:6px 10px;border-radius:999px; }
  </style>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
	<div style="margin-top:12px;">
  <input id="searchBox" 
         placeholder="T√¨m b√†i h√°t, ngh·ªá sƒ© ho·∫∑c album..."
         style="width:70%;padding:6px;border-radius:8px;border:1px solid #aad;"/>
  <button onclick="searchSpotify()" 
          style="padding:6px 12px;border-radius:8px;background:#8ec5ff;border:none;">
    üîç Search
  </button>
</div>

<div id="searchResults" 
     style="margin-top:8px;max-height:160px;overflow-y:auto;
            background:#edf3fa;border-radius:8px;padding:8px;">
</div>
    <div class="card">
        <div id="connect"><button onclick="connect()">Connect Spotify</button></div>
        <img id="cover" class="cover" src="" alt="cover" />
        <div class="title" id="title">Not playing</div>
        <div class="artist" id="artist">‚Äì</div>
        <div class="seek" style="position:relative;height:6px;border-radius:6px;background:#bde;padding:0 8px;margin:12px 0;">
  <div id="heart" style="position:absolute;top:-5px;width:16px;height:16px;left:0;">üíô</div>
</div>
        <div class="row">
            <button class="btn" onclick="prev()">‚èÆ</button>
            <button id="playbtn" class="btn" onclick="toggle()">‚ñ∂</button>
            <button class="btn" onclick="next()">‚è≠</button>
	<div class="row" style="margin-top:4px">
            <button class="btn" onclick="playDemo()">‚ñ∂ Demo</button>
<div id="connectStatus" style="color:#4ef; font-weight:600; margin-bottom:8px;">‚ùå Not connected</div>

        </div>
        </div>
<div id="lyricsBox" 
     style="margin-top:10px;padding:10px;
            background:#edf3fa;border-radius:12px;
            height:150px;overflow-y:auto;
            font-size:14px;line-height:1.6;">
  <i>üéµ Lyrics s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</i>
</div>

        <div id="playlists" 
     style="max-height:150px;overflow-y:auto;margin-top:8px;
            padding:6px;border-radius:8px;background:#edf2fa;">
  <button onclick="loadPlaylists()">üìö Load My Playlists</button>
</div>
    </div>
<script>
let deviceId = null;
let player = null;
let playing = false;

function token() {
  return localStorage.getItem('spotify_token');
}
function setStatus(msg) {
  const el = document.getElementById('connectStatus');
  if (el) el.textContent = msg;
}

/* --- API Helper --- */
async function api(path, method='GET', body=null) {
  const t = token();
  if (!t) throw new Error('No token');
  const res = await fetch('https://api.spotify.com/v1/' + path, {
    method,
    headers: {
      'Authorization': 'Bearer ' + t,
      ...(body ? {'Content-Type': 'application/json'} : {})
    },
    body: body ? JSON.stringify(body) : null
  });
  if (!res.ok) {
    const msg = await res.text().catch(()=>res.statusText);
    throw new Error(msg || res.statusText);
  }
  return res.status === 204 ? null : res.json();
async function loadPlaylists() {
  const t = token();
  if (!t) return alert('Ch∆∞a c√≥ token!');
  const res = await fetch("https://api.spotify.com/v1/me/playlists", {
    headers: { Authorization: "Bearer " + t }
  });
  const data = await res.json();
  const list = document.getElementById("playlists");
  list.innerHTML = "";
  data.items.forEach(p => {
    const el = document.createElement("div");
    el.className = "playlist-item";
    el.textContent = p.name;
    el.onclick = () => playPlaylist(p.uri);
    list.appendChild(el);
  });
  console.log("Loaded playlists:", data.items);
}

async function playPlaylist(uri) {
  if (!deviceId) return alert("Device ch∆∞a s·∫µn s√†ng!");
  await activateDevice();
  await api(`me/player/play?device_id=${deviceId}`, "PUT", { context_uri: uri });
  setStatus("üé∂ Playing playlist...");
}
}

/* --- Transfer sang thi·∫øt b·ªã Web (Sleptify) --- */
async function activateDevice() {
  const t = token();
  if (!t || !deviceId) return false;
  try {
    await api('me/player', 'PUT', { device_ids: [deviceId], play: false });
    console.log('Device transferred to Sleptify:', deviceId);
    return true;
  } catch (e) {
    console.warn('Transfer failed:', e);
    return false;
  }
}

/* --- Kh·ªüi t·∫°o SDK --- */
async function connect() {
  const t = token();
  if (!t) { alert('Ch∆∞a c√≥ token. H√£y b·∫•m Connect Spotify ·ªü c·ª≠a s·ªï ch√≠nh.'); return; }

  setStatus('‚è≥ Initializing SDK...');
  console.log('SDK starting...');

  window.onSpotifyWebPlaybackSDKReady = () => {
    console.log('SDK script loaded.');
    player = new Spotify.Player({
      name: 'Sleptify Desktop Player',
      getOAuthToken: cb => cb(t),
      volume: 0.85
    });

    player.addListener('ready', ({ device_id }) => {
      deviceId = device_id;
      setStatus('‚úÖ SDK ready ‚Äî ' + deviceId);
      console.log('Device ID:', deviceId);

      // T·ª± ƒë·ªông k√≠ch ho·∫°t device
      setTimeout(async () => {
        const ok = await activateDevice();
        if (ok) setStatus('üíô Web Player Active');
      }, 1000);
    });

    player.addListener('not_ready', ({ device_id }) => {
      setStatus('‚ö†Ô∏è Device not ready: ' + device_id);
    });

    player.addListener('player_state_changed', s => {
      if (!s) return;
      playing = !s.paused;
      document.getElementById('playbtn').innerText = playing ? '‚ùö‚ùö' : '‚ñ∂';
      const tr = s.track_window.current_track;
      document.getElementById('title').textContent  = tr?.name ?? 'Not playing';
      document.getElementById('artist').textContent = (tr?.artists||[]).map(a=>a.name).join(', ');
      if (tr?.album?.images?.length) {
        document.getElementById('cover').src = tr.album.images[0].url;
	if (tr?.name && tr?.artists?.length) {
  fetchLyrics(tr.name, tr.artists[0].name);
}
      }
 const bar = document.querySelector('.seek');
  const heart = document.getElementById('heart');
  if (bar && heart && s.duration > 0) {
    clearInterval(window._seekInterval);
    window._seekInterval = setInterval(() => {
      player.getCurrentState().then(state => {
        if (!state) return;
        const pct = state.position / state.duration;
        heart.style.left = (pct * (bar.clientWidth - 16)) + "px";
      });
    }, 500);
  }
    });

    player.connect();
  };

  if (typeof Spotify === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://sdk.scdn.co/spotify-player.js';
    document.head.appendChild(s);
  } else {
    window.onSpotifyWebPlaybackSDKReady();
  }
}

/* --- C√°c n√∫t ƒëi·ªÅu khi·ªÉn --- */
async function toggle() {
  if (!deviceId) return alert('Device ch∆∞a s·∫µn s√†ng');
  const ep = playing ? 'pause' : 'play';
  await api(`me/player/${ep}?device_id=${deviceId}`, 'PUT');
}
async function next() {
  if (!deviceId) return alert('Device ch∆∞a s·∫µn s√†ng');
  await api(`me/player/next?device_id=${deviceId}`, 'POST');
}
async function prev() {
  if (!deviceId) return alert('Device ch∆∞a s·∫µn s√†ng');
  await api(`me/player/previous?device_id=${deviceId}`, 'POST');
}

/* --- Play demo track --- */
async function playDemo() {
  if (!deviceId) return alert('Device ch∆∞a s·∫µn s√†ng');
  const demo = 'spotify:track:4cOdK2wGLETKBW3PvgPWqT'; // Never Gonna Give You Up :v
  await activateDevice();
  await api(`me/player/play?device_id=${deviceId}`, 'PUT', { uris: [demo] });
  setStatus('üéµ Playing demo track...');
}

/* --- Khi trang load --- */
document.addEventListener('DOMContentLoaded', ()=>{
  if (token()) setStatus('üîë Token ready');
});
async function loadPlaylists() {
  const t = token();
  if (!t) return alert('Ch∆∞a c√≥ token!');
  const res = await fetch("https://api.spotify.com/v1/me/playlists", {
    headers: { Authorization: "Bearer " + t }
  });
  const data = await res.json();
  const list = document.getElementById("playlists");
  list.innerHTML = "";
  data.items.forEach(p => {
    const el = document.createElement("div");
    el.className = "playlist-item";
    el.textContent = p.name;
    el.onclick = () => playPlaylist(p.uri);
    list.appendChild(el);
  });
  console.log("Loaded playlists:", data.items);
}

async function playPlaylist(uri) {
  if (!deviceId) return alert("Device ch∆∞a s·∫µn s√†ng!");
  await activateDevice();
  await api(`me/player/play?device_id=${deviceId}`, "PUT", { context_uri: uri });
  setStatus("üé∂ Playing playlist...");
}
async function searchSpotify() {
  const q = document.getElementById("searchBox").value.trim();
  if (!q) return alert("Nh·∫≠p t·ª´ kh√≥a c·∫ßn t√¨m!");
  const t = token();
  if (!t) return alert("Ch∆∞a c√≥ token!");
  setStatus("üîé ƒêang t√¨m ki·∫øm...");
  const res = await fetch(
    `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track,artist,album,playlist&limit=10`,
    { headers: { Authorization: "Bearer " + t } }
  );
  const data = await res.json();
  const list = document.getElementById("searchResults");
  list.innerHTML = "";

  const tracks = data.tracks?.items || [];
  if (tracks.length === 0) {
    list.innerHTML = "<div style='opacity:0.7'>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</div>";
    return;
  }

  tracks.forEach(track => {
    const el = document.createElement("div");
    el.className = "track-item";
    el.style = "padding:6px;cursor:pointer;border-bottom:1px solid #ccd;";
    el.innerHTML = `
      <div><b>${track.name}</b> ‚Äî ${track.artists.map(a=>a.name).join(", ")}</div>
      <small>${track.album.name}</small>
    `;
    el.onclick = () => playTrack(track.uri);
    list.appendChild(el);
  });

  setStatus("‚úÖ T√¨m th·∫•y " + tracks.length + " b√†i h√°t");
}

async function playTrack(uri) {
  if (!deviceId) return alert("Device ch∆∞a s·∫µn s√†ng!");
  await activateDevice();
  await api(`me/player/play?device_id=${deviceId}`, "PUT", { uris: [uri] });
  setStatus("üéß Playing track...");
}
async function fetchLyrics(trackName, artistName) {
  const box = document.getElementById("lyricsBox");
  box.innerHTML = "‚è≥ ƒêang t·∫£i lyrics...";
  try {
    const url = `https://lrclib.net/api/get?track_name=${encodeURIComponent(trackName)}&artist_name=${encodeURIComponent(artistName)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data || !data.syncedLyrics) {
      box.innerHTML = "<i>Kh√¥ng t√¨m th·∫•y lyrics cho b√†i n√†y üò¢</i>";
      return;
    }

    const lines = data.syncedLyrics.split("\n").filter(x => x.trim());
    box.innerHTML = lines.map(l => l.replace(/\[\d+:\d+.\d+\]/, "").trim()).join("<br>");
  } catch (e) {
    console.error(e);
    box.innerHTML = "<i>L·ªói khi t·∫£i lyrics üò•</i>";
  }
}



</script>


</body>
</html>
